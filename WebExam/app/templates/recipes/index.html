{% extends 'base.html' %}
{% block title %}Рецепты{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h1>Рецепты</h1>
  {% if current_user.is_authenticated %}
    <a class="btn btn-success" href="{{ url_for('recipes.create') }}">Добавить рецепт</a>
  {% endif %}
</div>

<div class="list-group mt-3">
  {% for r in recipes %}
    <div class="list-group-item">
      <div class="d-flex w-100 justify-content-between">
        <h5 class="mb-1">{{ r.title }}</h5>
        <small class="text-muted">{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
      </div>
      <p class="mb-1">Время: {{ r.cook_time_min }} мин | Порции: {{ r.servings }}</p>
      {% set agg = reviews_agg.get(r.id, { 'count':0, 'sum':0 }) %}
      {% set avg = (agg.sum / agg.count) if agg.count else 0 %}
      <p class="mb-1">Средняя оценка: {{ '%.1f' % avg }} ({{ agg.count }})</p>
      <div>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('recipes.view', recipe_id=r.id) }}">Просмотр</a>
        {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == r.author_id) %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('recipes.edit', recipe_id=r.id) }}">Редактирование</a>
          <form method="post" action="{{ url_for('recipes.delete', recipe_id=r.id) }}" class="d-inline" onsubmit="return confirm('Вы уверены, что хотите удалить рецепт {{ r.title }}?');">
            <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
          </form>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">Пока нет рецептов</div>
  {% endfor %}
</div>

<nav class="mt-3">
  <ul class="pagination">
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('recipes.index', page=pagination.prev_num) }}">Назад</a>
    </li>
    <li class="page-item disabled"><span class="page-link">Стр. {{ pagination.page }} из {{ pagination.pages }}</span></li>
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('recipes.index', page=pagination.next_num) }}">Вперёд</a>
    </li>
  </ul>
</nav>
{% endblock %}
